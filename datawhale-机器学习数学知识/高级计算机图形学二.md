# 高级计算机图形学二

> Lecture 04 Transformation Cont.

如果对矩阵进行顺时针旋转$\theta$角度，那应该怎么样表示。还是使用特殊值带入可以得到。我们发现更好是逆时针旋转$\theta$角度的逆矩阵。在数学上，一个矩阵的逆矩阵恰好是该矩阵的话，我们称之为正交矩阵。

![image-20211021091421442](高级计算机图形学二.assets/image-20211021091421442.png)



- 概述

  - 3D  变换
  - 观测变换
    - 视图/相机 变换
    - 投影变换 
      - 正交投影
      - 透视投影

- 3D 变换

  - ![image-20211021091930832](高级计算机图形学二.assets/image-20211021091930832-1634779171764.png)

  - ![image-20211021092014457](高级计算机图形学二.assets/image-20211021092014457-1634779215100.png)

  - ![image-20211021092038338](高级计算机图形学二.assets/image-20211021092038338.png)

  - 如果**绕着坐标轴旋转**，变换如图所示。注意绕$y$轴旋转的话，有点不一样。原因是之前说叉乘确定方向是右手定则，$x$ 与$z$ 叉乘得到的向量与$y$轴方向相反，使用$y$轴的变换矩阵比较特殊（$y$是由$\vec{z}$ 叉乘$\vec{x}$得到）。

    绕着一个坐标轴旋转，其所属坐标保存不变，其他坐标转换为2D旋转模型。

  - ![image-20211021092052009](高级计算机图形学二.assets/image-20211021092052009.png)

  - 一般旋转

    - 我们能否使用绕轴旋转的组合得到一般旋转？

      ![image-20211021095025715](高级计算机图形学二.assets/image-20211021095025715.png)

    - 一般旋转通用公式：![image-20211021095125958](高级计算机图形学二.assets/image-20211021095125958.png)

      公式证明过程：

      ![image-20211021095236255](高级计算机图形学二.assets/image-20211021095236255.png)

      - 和2D变换相似，我们的旋转是默认原点旋转。首先我们讲其平移到原点，然后进行旋转，然后再平移到目标位置。
      - 拓展：老师建议学有余力的同学可以考虑了解`四元数`知识

- View/ Camera Transfomation

  - ![image-20211021105015929](高级计算机图形学二.assets/image-20211021105015929.png)

  - 如何完成视图变换

    - 首先定义相机

      - 位置
      - 朝向
      - 旋转方向

      ![image-20211021105315141](高级计算机图形学二.assets/image-20211021105315141.png)

    - 关键观察

      ![image-20211021105520073](高级计算机图形学二.assets/image-20211021105520073.png)

    - 通过$M_{view}$矩阵改变相机![image-20211021105725142](高级计算机图形学二.assets/image-20211021105725142.png)

    - 首先通过平移移动到原点坐标，变换为$T_{view}$;把$t$轴放置到$y$轴，把$g$轴放置到$-z$轴，但是直接映射不太好写，如果放过来，把$x、y、z$轴发过来的话，比较方便，然后进行逆变换：![image-20211021110043296](高级计算机图形学二.assets/image-20211021110043296.png)

      旋转变换矩阵是正交矩阵，其逆矩阵为它的转置矩阵。

    - ![image-20211021111327085](高级计算机图形学二.assets/image-20211021111327085.png)

- Projection transformation

  - 有两种投影，一一种是正交投影，一种是透视投影

  - ![image-20211021111611244](高级计算机图形学二.assets/image-20211021111611244.png)

  - 正交投影

    ![image-20211021135514273](高级计算机图形学二.assets/image-20211021135514273.png)

    ![image-20211021135545335](高级计算机图形学二.assets/image-20211021135545335.png)

    把$Z$扔掉，这所有的平面都在$x$ $y$ 平面上，然后把结果变成[-1,1]范围。

    问题： 如何判断前后面？

  - 如何把物体映射到正交平面

    ![image-20211021140125995](高级计算机图形学二.assets/image-20211021140125995.png)

    ![image-20211021140312100](高级计算机图形学二.assets/image-20211021140312100.png)

    转换为矩阵变换的表示，先平移再调整规格：

    ![image-20211021140407559](高级计算机图形学二.assets/image-20211021140407559.png)

    ![image-20211021140605049](高级计算机图形学二.assets/image-20211021140605049.png)

    

    因为选定的坐标轴使用右手定则，所以远近的方面恰好相反。

    OpenGL使用的$Z$轴和我们这里假定的相反，所以出现相反的结果是合理现象

  - 视图投影——使用最广泛的投影
  
    ![image-20211021195658594](高级计算机图形学二.assets/image-20211021195658594-1634817421227.png)
  
  - 在同一平面内，两个平行线不会相交。但是在透视投影中，平行线是会相交的。
  
  - ![image-20211021200243685](高级计算机图形学二.assets/image-20211021200243685.png)
  
  - 如何做视图投影
  
    - 挤压Frustum挤压成Cuboid
  
    - ![image-20211021201016827](高级计算机图形学二.assets/image-20211021201016827.png)
  
    - ![image-20211021201346936](高级计算机图形学二.assets/image-20211021201346936.png) 给定$y$变化可以得知变换，最后推广到$x、z$
  
    - ![image-20211021201507652](高级计算机图形学二.assets/image-20211021201507652.png)
  
    - ![image-20211021201701244](高级计算机图形学二.assets/image-20211021201701244.png)
  
      根据$x、y、z$如何变换，可以得到矩阵$M_{persp->ortho}$ ,只剩下第三行不知道。
  
    - ![image-20211021201952669](高级计算机图形学二.assets/image-20211021201952669.png)
  
      近的平面上任何点不会变换，远的平面$z$轴的点不会变换
  
    - ![image-20211021202215173](高级计算机图形学二.assets/image-20211021202215173.png)
  
      上图中，在近端$x,y$保持不变。所以$(0\space \space 0 \space \space A \space B)$
  
    - ![image-20211021203129940](高级计算机图形学二.assets/image-20211021203129940.png)
  
    - 列方程解出$A\space B$。这一步完成了解压操作，把平面挤压成了正交投影；之后进行正交变换。这样的结果可以得到最终变换。![image-20211021203334178](高级计算机图形学二.assets/image-20211021203334178.png)











> Lecture 05 Rasterization 1 (Triangles)



垂直的可视角度，这样可以描述一个相机侧面的视野的大小，使用field-of-view(fovY)来形容

![image-20211021213126466](高级计算机图形学二.assets/image-20211021213126466.png)

如何使用可视角度来形容l,r,b,t?如图：

- ![image-20211021213512789](高级计算机图形学二.assets/image-20211021213512789.png)

- MVP

  - Model transformation  放置物体
  - View transformation 放置相机
  - Projection transformation
    - 正交变换 转到$[-1,1]^3$
    - 视图变换 物体转到正交变换

- MVP变换之后要转移到屏幕上

  - 屏幕：像素构成、有一定分辨率
  - 光栅： 屏幕
    - `光栅化`：**投影到屏幕**

  

- 定义屏幕空间

  ![image-20211021214949444](高级计算机图形学二.assets/image-20211021214949444.png)

- 像素这里表示和$z$轴无关，我们只要把$xy$平面[-1,1]转换到[0,width],[0,height]

- ![image-20211021215240443](高级计算机图形学二.assets/image-20211021215240443.png)

  矩阵变换为：![image-20211021215250381](高级计算机图形学二.assets/image-20211021215250381.png)



为什么选择三角形：

- 最基本的多边形

  - 构成其他多边形

- 独特的性质（和多边形比较）

  - 内部一定是平面，不能折叠成多个平面
  - 三角形内部外部定义的很清晰
  - Well-defined method for interpolating values at vertices over triangle

- ![image-20211021221821727](高级计算机图形学二.assets/image-20211021221821727.png)

-  采样函数

  - 通过采样离散化一个函数
  - 采样在图形学中是一个很核心的概念
    - We sample time (1D), area (2D), direction (2D), volume (3D)

- 判断像素是否在三角形中

  - ![image-20211021222939058](高级计算机图形学二.assets/image-20211021222939058.png)

  - 通过右手定则判断一个点在三角形的左侧、右侧。比如$P_0 P_1$  $P_0Q$ 中

    ![image-20211021223305648](高级计算机图形学二.assets/image-20211021223305648.png)

  - 在边上的点，是做处理还是不处理。这个自己定义即可，本书假定该点不做处理。在OpenGL有特别的规定。

  - 如果全部做光栅化的话，这样的话，很容易造成浪费。我们可以先确定其边界。![image-20211021232931182](高级计算机图形学二.assets/image-20211021232931182.png)

  - 也可以直接确定三角形的上下边界来确定：

  - ![image-20211021233014042](高级计算机图形学二.assets/image-20211021233014042.png)



- 如果我们想要发送如下图需要表示的采样信号：![image-20211021233411473](高级计算机图形学二.assets/image-20211021233411473.png)

  我们会得到如下图的情况：

  ![image-20211021233430370](高级计算机图形学二.assets/image-20211021233430370.png)

  锯齿十分明显，如何解决锯齿问题，也是光栅化一直在处理的情况。









> Lecture 06 Rasterization 2 (Antialiasing and Z-Buffering)

上节课提及到锯齿的情况，本节课进行接着说：

光栅化空间中的点，但是会出现锯齿的情况，比如：![image-20211022083214780](高级计算机图形学二.assets/image-20211022083214780.png)

**Sampling Artifacts**(Errors/Mistakes/Inaccuracies) in Computer Graphics,使用Sampling Artifacts来形容图形学中采样存在的问题，英译过来效果不好。

比如：

- ​	锯齿![image-20211022083727018](高级计算机图形学二.assets/image-20211022083727018.png)

- 之前课程提及到只考虑每次采样只采用两行中一个![image-20211022083803794](高级计算机图形学二.assets/image-20211022083803794.png)

- 比如生活中，使用手机拍摄电子屏幕时，出现糊状图片

- 车轮效应（人眼采样的速度跟不上物体运动的速度）：![image-20211022084101453](高级计算机图形学二.assets/image-20211022084101453.png)

  找出Aliasing Artifacts 原因：信号改变的太快（高频率），但是采样比较慢

- 对信号进行滤波（对信号模糊）：

  - ![image-20211022084501388](高级计算机图形学二.assets/image-20211022084501388.png)

  - ![image-20211022084509983](高级计算机图形学二.assets/image-20211022084509983.png)

  - 直接采样与 先做滤波，后采样对比：

    ![image-20211022084902720](高级计算机图形学二.assets/image-20211022084902720.png)

  - 如果不是先做滤波，后采样；而是采样后滤波会出现什么：

    ![image-20211022084916387](高级计算机图形学二.assets/image-20211022084916387.png)

  - 为什么呢？我们看看antialiased rasterization如何实现

Frequency Domain (频域)

我们先观察数学的函数：![image-20211022085304998](高级计算机图形学二.assets/image-20211022085304998.png)

使用正弦余弦之和表示函数：![image-20211022085748322](高级计算机图形学二.assets/image-20211022085748322.png)

傅里叶变换可以把信号转换为频率：

- ![image-20211022090005909](高级计算机图形学二.assets/image-20211022090005909.png)

- 高频率需要更快的采样：

  ![image-20211022094218162](高级计算机图形学二.assets/image-20211022094218162.png)

  如图，如果采样的点（采样的频率较低），那么就跟不上频率变化，特别是当频率越来越高的时候。

- 走样(aliase)：同一一个采样的方法采样两种不同频率的函数得出的结果，我们无法区分它。![image-20211022094821352](高级计算机图形学二.assets/image-20211022094821352.png)

- 滤波：把某个特定的频段抹掉

- 图片中把中心变成低频的频域，周围变成高频的频域。对于自然的图片中，傅里叶变换一张图，低频信息集中在中间。做傅里叶变换的过程中，图片是多个竖直方向和水平方向层叠，所以会出现中间竖直方向、水平方向的一条线。![image-20211022095251531](高级计算机图形学二.assets/image-20211022095251531.png)

- 在图片中，我们把低频去掉。那高频的信息长什么样，我们使用逆傅里叶变换即可得到，这种方式叫做`高通滤波`：

  什么是边界：变化比较大的

  ![image-20211022095711205](高级计算机图形学二.assets/image-20211022095711205.png)

- 在图片中，我们把高频去掉。那低频的信息长什么样，我们使用逆傅里叶变换即可得到，这种方式叫做`低通滤波`：

  相对于上面一种情况，边界模糊了，恰好与之相对

  ![image-20211022100037567](高级计算机图形学二.assets/image-20211022100037567.png)

- 如果低频和高频都去掉，只保留如下图频率部分信息，情况如图：![image-20211022100259472](高级计算机图形学二.assets/image-20211022100259472.png)

- 如果把低频信息多去一些，保留相对多的高频信息，边界会更明显：![image-20211022100513117](高级计算机图形学二.assets/image-20211022100513117.png)

- 上面低频高频信息初步如此，更加深入可以学习`图像数字处理`课程



滤波 = 卷积（图形学上简化定义） = 平均

卷积操作：使用过滤器点乘信号![image-20211022100933077](高级计算机图形学二.assets/image-20211022100933077.png)

上面的数值使用的是加权平均，也可以称为`卷积`。

- 在空间领域进行卷积操作等同于在频域中进行乘积操作。只要有两种方式：
  - 在空间中使用卷积过滤

  - 转换为频域（傅里叶变换）、使用卷积核的傅里叶变换相乘、转换回空间（反向傅里叶变换）

    时域的卷积等于频率的乘积（不是很好理解，这个是一个结论）

  ![image-20211022102537441](高级计算机图形学二.assets/image-20211022102537441.png)

- 卷积核作用等同低通过滤器![image-20211022103106118](高级计算机图形学二.assets/image-20211022103106118.png)

  如果卷积核大一些，那相对于更加模糊（假定卷积核大于这个图片，那整张图片都是一个颜色，这一就"超级"模糊了，边界更不清晰了）。这里闫大佬使用具体的先说明，后面再推广到一般。![image-20211022103255365](高级计算机图形学二.assets/image-20211022103255365.png)



什么是采样? 采样就是重复频率内容。![image-20211022104119416](高级计算机图形学二.assets/image-20211022104119416.png)

为什么之前会出现采样点不足而导致频率无法准确描述，这里使用频域解释，当采样点越稀疏，频率之间容易混合。![image-20211022104454924](高级计算机图形学二.assets/image-20211022104454924.png)

如何减少走样错误：

1. 增加采样率——毋庸置疑，有点废话

2. Antialiasing反走样——先模糊，后采样

   - 过程：先模糊，使用低通滤波![image-20211022105057338](高级计算机图形学二.assets/image-20211022105057338.png)

   - 如何进行模糊操作：![image-20211022105230562](高级计算机图形学二.assets/image-20211022105230562.png)

     通过计算一个像素周围的平均值，也就是卷积操作。（最开始的时候，与闫神所说相对于  过滤=平均=卷积）

     ![image-20211022105616255](高级计算机图形学二.assets/image-20211022105616255.png)

     



- MSAA——Supersample
  - ![image-20211022112829875](高级计算机图形学二.assets/image-20211022112829875.png)
  - ![image-20211022112844340](高级计算机图形学二.assets/image-20211022112844340.png)
  - ![image-20211022112858858](高级计算机图形学二.assets/image-20211022112858858.png)

其他抗锯齿的方法：

- FXAA(Fast Approximate AA)
- TAA(Temporal AA)

超分辨率：

- ​	从低分辨率到高分辨率
- 还是不能解决“采样不足”问题
- 使用深度学习方法猜测

